name: Deploy to AWS Amplify

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    types: [ opened, synchronize, reopened ]

# Evitar mÃºltiples deploys simultÃ¡neos
concurrency:
  group: amplify-deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read
  pull-requests: read

env:
  AWS_REGION: us-east-1
  NODE_ENV: production

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-
        
    - name: Install dependencies
      run: bun install --frozen-lockfile
      
    - name: Build project
      run: bun run build
      env:
        NEXT_PUBLIC_APP_URL: ${{ secrets.AMPLIFY_APP_URL }}
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-${{ github.run_id }}
        
    - name: Deploy to Amplify
      run: |
        # Crear deployment
        echo "Creating deployment..."
        DEPLOYMENT_ID=$(aws amplify create-deployment \
          --app-id ${{ secrets.AMPLIFY_APP_ID }} \
          --branch-name master \
          --query 'deploymentId' \
          --output text)
        
        echo "Deployment ID: $DEPLOYMENT_ID"
        
        # Preparar archivos para deploy
        echo "Preparing deployment package..."
        zip -r deploy.zip .next package.json amplify.yml -q
        
        # Obtener URL de upload
        UPLOAD_URL=$(aws amplify get-deployment \
          --app-id ${{ secrets.AMPLIFY_APP_ID }} \
          --branch-name master \
          --deployment-id $DEPLOYMENT_ID \
          --query 'deployment.sourceUrl' \
          --output text)
        
        # Subir archivos
        echo "Uploading deployment package..."
        curl -T deploy.zip "$UPLOAD_URL" --silent --show-error
        
        # Iniciar deployment
        echo "Starting deployment..."
        aws amplify start-deployment \
          --app-id ${{ secrets.AMPLIFY_APP_ID }} \
          --branch-name master \
          --deployment-id $DEPLOYMENT_ID
          
        echo "âœ… Deployment started successfully!"
        echo "ðŸš€ App URL: ${{ secrets.AMPLIFY_APP_URL }}"
        
    - name: Cleanup
      if: always()
      run: |
        rm -f deploy.zip
        rm -f amplify-policy.json
        rm -f github-trust-policy.json
